# opkssh-renewer

This is a wrapper for [opkssh](https://github.com/openpubkey/opkssh) to renew certificates and (re-)add them to a running ssh-agent.

By default, if the expected key/certificate is not found or is older than 23-hours it will be renewed by running the opkssh login process (this does not depend on the opkssh binary being present).

## Motivation

At the moment, opkssh does not directly support adding keys issued via the OIDC login process to a running ssh-agent process, so implementing this bidges that gap for tye time being.

## Command Line Options

The following command line options are supported:

* `--debug` - Enable debug logging
* `--force` - Force the renwwal of identity even if it is not required
* `--maxage` - Age of identity before renewal is required (default `23h`)
* `--name` - Name of identity file(s) (default `id_opkssh`)

## Process

Running `opkssh-renewer` performs the following steps:

1. Short lived SSH key/certificate generated by "opkssh" is checked for age (by default "~/.ssh/id_opkssh")
2. If this file is older than 23-hours the "opkssh login" process is started to generate a new identity to a temporary directory (by default "~/.ssh/opksshXXXXXX/")
3. Assuming this completes the resulting key/certificate are added to the "ssh-agent"
4. The old identity is removed from the "ssh-agent"
5. The new identity files are moved into place

## Requirements

### Windows

1. The "OpenSSH Agent" Windows service must be set to "Manual" startup
2. Run "ssh-agent.exe"
3. Configure "opkssh" for your chosent identity provider (optional)

### Linux

The SSH agent must be running and the  "SSH_AUTH_SOCK" environment variable must be set:

```sh
eval 'ssh-agent -s'
```

## Using with PuTTY

As PuTTY has it's own SSH agent implementatation (Pageant), you must use a bridge between the two protocols such as https://github.com/ndbeals/winssh-pageant.

This implementation will allow PuTTY to use keys added to the native Windows ssh-agent.

## GUI

A GUI is available however this is in early stages of development and is not expected to be reliable.

The GUI runs as a daemon and will provide a notification when the current identity is close to or has expired and allow renewing of this identity.

This is a very unpolished solution at this time and should not be relied upon for production use.

### Known Issues

On systems with graphics cards that do not fully implement/support OpenGL 2.0 (such as a virtual machine), it is requried to have `openGL32.dll` fil from [Mesa3D](https://fdossena.com/?p=mesa/index.frag) anlongside the executable to provide software rendering for OpenGL.
